// Prisma Schema for TJMUN Website
// 数据源：PostgreSQL
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 1. 用户模型 (用于注册 & 管理员角色)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  hashedPassword String?  @map("hashed_password")
  name          String
  school        String?   @default("同济大学")
  major         String?
  phone         String?
  role          UserRole  @default(STUDENT)
  createdAt      DateTime  @default(now()) @map("created_at")

  registrations Registration[]
  announcements Announcement[]
  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

enum UserRole {
  STUDENT
  ADMIN
}

// 2. 公告模型 (用于发布新闻)
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  status      Status   @default(DRAFT)
  authorId    String   @map("author_id")
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  publishedAt DateTime? @map("published_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("announcements")
}

enum Status {
  DRAFT
  PUBLISHED
}

// 3. 会议模型 (用于发布大会信息)
model Conference {
  id                    String    @id @default(cuid())
  name                  String    @unique
  slug                  String    @unique
  description           String    @db.Text
  startDate             DateTime  @map("start_date")
  endDate               DateTime  @map("end_date")
  registrationOpenDate  DateTime  @map("registration_open_date")
  registrationCloseDate DateTime  @map("registration_close_date")
  fee                   Decimal   @default(0.0) @db.Decimal(10, 2)
  testRequired          Boolean   @default(false) @map("test_required")
  testPromptUrl         String?   @map("test_prompt_url")
  createdAt             DateTime  @default(now()) @map("created_at")

  registrations Registration[]

  @@map("conferences")
}

// 4. 报名模型 (核心功能)
model Registration {
  id                    String            @id @default(cuid())
  userId                String            @map("user_id")
  conferenceId          String            @map("conference_id")
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  conference            Conference        @relation(fields: [conferenceId], references: [id], onDelete: Cascade)

  registrationStatus    RegistrationStatus @default(PENDING) @map("registration_status")
  academicTestUrl       String?           @map("academic_test_url")
  testScore             Int?              @map("test_score")
  paymentStatus         PaymentStatus     @default(UNPAID) @map("payment_status")
  paymentTransactionId  String?           @map("payment_transaction_id")

  registeredAt          DateTime          @default(now()) @map("registered_at")

  @@unique([userId, conferenceId])
  @@map("registrations")
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  WAITLISTED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

// 5. 网站配置模型 (用于公示联系方式)
model SiteConfig {
  id        String @id @default(cuid())
  key       String @unique
  value     String @db.Text
  label     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("site_configs")
}

// NextAuth.js 所需的标准模型
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

